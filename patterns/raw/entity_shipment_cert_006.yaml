# Entity Pattern: Shipment and Certification Lookup
# Discovered: Phase 1A - TBox Entity Patterns
# Complexity: GREEN

name: shipment_certification_entity_patterns
complexity: GREEN
description: Entity lookup and filtering patterns for Shipment and SupplierCertification classes

ontology_bindings:
  - class: Shipment
    table: shipments
    identifier: shipment_number
  - class: SupplierCertification
    table: supplier_certifications
    identifier: "[supplier_id, certification_type]"

patterns:
  # Shipment patterns
  - name: shipment_by_number
    description: "Lookup shipment by shipment number"
    applicability:
      keywords: [shipment, find, lookup, number, SHP, tracking]
      intent: "Find a specific shipment by its number"
    parameters:
      - name: shipment_number
        type: string
        required: true
        example: "SHP-00000001"
    sql_template: |
      SELECT id, shipment_number, carrier, tracking_number,
             status, shipped_at, delivered_at, weight_kg, cost_usd
      FROM shipments
      WHERE shipment_number = {{shipment_number}}
    execution:
      time_ms: 3.0

  - name: shipments_by_status
    description: "List shipments filtered by status"
    applicability:
      keywords: [shipments, status, in_transit, delivered, pending, failed]
      intent: "Find all shipments with a specific status"
    parameters:
      - name: status
        type: string
        required: true
        values: [pending, in_transit, delivered, failed]
    sql_template: |
      SELECT id, shipment_number, carrier, shipped_at, cost_usd
      FROM shipments
      WHERE status = {{status}}
      ORDER BY shipped_at DESC
      LIMIT 100
    execution:
      time_ms: 2.8
      result: "in_transit: 4001, delivered: 3994"

  - name: shipments_by_carrier
    description: "Count shipments by carrier"
    applicability:
      keywords: [shipments, carrier, logistics, provider]
      intent: "Get shipment counts grouped by carrier"
    parameters: []
    sql_template: |
      SELECT carrier, COUNT(*) as shipment_count
      FROM shipments
      GROUP BY carrier
      ORDER BY shipment_count DESC
      LIMIT 10
    execution:
      time_ms: 8.4

  - name: avg_shipping_cost_by_carrier
    description: "Average shipping cost by carrier"
    applicability:
      keywords: [shipping, cost, carrier, average, price]
      intent: "Get average shipping cost by carrier"
    parameters: []
    sql_template: |
      SELECT carrier,
             ROUND(AVG(cost_usd)::numeric, 2) as avg_cost
      FROM shipments
      GROUP BY carrier
      ORDER BY avg_cost DESC
      LIMIT 10
    execution:
      time_ms: 8.4

  # Supplier Certification patterns
  - name: certifications_by_type
    description: "Count certifications by type"
    applicability:
      keywords: [certifications, type, ISO, IATF, AS9100, count]
      intent: "Get certification counts by type"
    parameters: []
    sql_template: |
      SELECT certification_type, COUNT(*) as cert_count
      FROM supplier_certifications
      GROUP BY certification_type
      ORDER BY cert_count DESC
    execution:
      time_ms: 1.2
      result: "IATF16949: 132, ISO14001: 132, AS9100: 128, ISO27001: 126, ISO9001: 122"

  - name: valid_certifications_by_type
    description: "Count valid certifications by type"
    applicability:
      keywords: [valid, certifications, type, current, active]
      intent: "Get count of currently valid certifications by type"
    parameters: []
    sql_template: |
      SELECT certification_type, COUNT(*) as valid_count
      FROM supplier_certifications
      WHERE is_valid = true
      GROUP BY certification_type
      ORDER BY valid_count DESC
    execution:
      time_ms: 1.2

  - name: expiring_certifications
    description: "Certifications expiring within timeframe"
    applicability:
      keywords: [certifications, expiring, expiry, renewal, soon, alert]
      intent: "Find certifications expiring within a given number of days"
    parameters:
      - name: days
        type: integer
        required: false
        default: 90
    sql_template: |
      SELECT sc.certification_type, sc.expiry_date,
             s.supplier_code, s.name as supplier_name
      FROM supplier_certifications sc
      JOIN suppliers s ON sc.supplier_id = s.id
      WHERE sc.expiry_date BETWEEN CURRENT_DATE
            AND CURRENT_DATE + INTERVAL '{{days}} days'
      ORDER BY sc.expiry_date
    execution:
      time_ms: 4.0

  - name: supplier_certification_count
    description: "Count certifications per supplier"
    applicability:
      keywords: [supplier, certifications, count, compliance]
      intent: "Get count of certifications held by each supplier"
    parameters: []
    sql_template: |
      SELECT s.supplier_code, s.name, COUNT(sc.id) as cert_count
      FROM suppliers s
      JOIN supplier_certifications sc ON s.id = sc.supplier_id
      GROUP BY s.id, s.supplier_code, s.name
      ORDER BY cert_count DESC
      LIMIT 20
    execution:
      time_ms: 5.4
