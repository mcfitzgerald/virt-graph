# Multi-Hop Chain Pattern: Customer → Order → Facility
# Discovered: Phase 1C - GREEN Multi-Hop Chains
# Complexity: GREEN

name: customer_shipping_chain
complexity: GREEN
description: Multi-hop chain connecting Customer to Facilities through Orders

ontology_bindings:
  chain:
    - role: placed_by
      direction: reverse
    - role: ships_from
      direction: forward
  entities: [Customer, Order, Facility]

patterns:
  - name: customer_shipping_facilities
    description: "Which facilities serve this customer's orders?"
    applicability:
      keywords: [customer, facilities, shipping, served by, orders from]
      intent: "Find shipping facilities used for a customer's orders"
    parameters:
      - name: customer_code
        type: string
        required: true
    sql_template: |
      SELECT c.customer_code, c.name as customer,
             f.facility_code, f.name as facility, f.city,
             COUNT(o.id) as order_count
      FROM customers c
      JOIN orders o ON o.customer_id = c.id
      JOIN facilities f ON o.shipping_facility_id = f.id
      WHERE c.customer_code = {{customer_code}}
      GROUP BY c.customer_code, c.name, f.facility_code, f.name, f.city
      ORDER BY order_count DESC
    execution:
      time_ms: 1.9

  - name: facility_customer_base
    description: "Which customers are served by this facility?"
    applicability:
      keywords: [facility, customers, served, orders to, customer base]
      intent: "Find customers whose orders ship from a specific facility"
    parameters:
      - name: facility_code
        type: string
        required: true
    sql_template: |
      SELECT f.name as facility, c.customer_code, c.name as customer,
             c.customer_type, COUNT(o.id) as orders,
             ROUND(SUM(o.total_amount)::numeric, 2) as total_value
      FROM facilities f
      JOIN orders o ON o.shipping_facility_id = f.id
      JOIN customers c ON o.customer_id = c.id
      WHERE f.facility_code = {{facility_code}}
      GROUP BY f.name, c.customer_code, c.name, c.customer_type
      ORDER BY total_value DESC
      LIMIT 20
    execution:
      time_ms: 1.9
