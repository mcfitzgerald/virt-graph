# Relationship Patterns: Shipment relationships
# Discovered: Phase 1B - GREEN Relationship Patterns
# Complexity: GREEN

name: shipment_relationship_patterns
complexity: GREEN
description: Relationship patterns for fulfills and originates_at roles

ontology_bindings:
  - role: fulfills
    domain: Shipment
    range: Order
    sql:
      table: shipments
      domain_key: order_id
      range_key: id
  - role: originates_at
    domain: Shipment
    range: Facility
    sql:
      table: shipments
      domain_key: origin_facility_id
      range_key: id

patterns:
  # fulfills patterns
  - name: shipment_order
    description: "Forward traversal: Find order fulfilled by a shipment"
    applicability:
      keywords: [shipment, order, fulfills, tracking]
      intent: "Find the order that a shipment fulfills"
    parameters:
      - name: shipment_number
        type: string
        required: true
    sql_template: |
      SELECT sh.shipment_number, sh.carrier, sh.status, sh.cost_usd,
             o.order_number, o.order_date, o.total_amount
      FROM shipments sh
      JOIN orders o ON sh.order_id = o.id
      WHERE sh.shipment_number = {{shipment_number}}
    execution:
      time_ms: 2.1

  - name: order_shipments
    description: "Reverse traversal: Find shipments for an order"
    applicability:
      keywords: [order, shipments, tracking, delivery, fulfillment]
      intent: "Find all shipments that fulfill a specific order"
    parameters:
      - name: order_number
        type: string
        required: true
    sql_template: |
      SELECT o.order_number, sh.shipment_number, sh.carrier,
             sh.status, sh.shipped_at, sh.delivered_at, sh.cost_usd
      FROM orders o
      JOIN shipments sh ON sh.order_id = o.id
      WHERE o.order_number = {{order_number}}
      ORDER BY sh.shipped_at
    execution:
      time_ms: 9.5

  # originates_at patterns
  - name: shipment_origin
    description: "Forward traversal: Find origin facility for a shipment"
    applicability:
      keywords: [shipment, origin, facility, from, source]
      intent: "Find where a shipment originates from"
    parameters:
      - name: shipment_number
        type: string
        required: true
    sql_template: |
      SELECT sh.shipment_number, sh.status,
             f.facility_code, f.name as facility, f.city, f.country
      FROM shipments sh
      JOIN facilities f ON sh.origin_facility_id = f.id
      WHERE sh.shipment_number = {{shipment_number}}
    execution:
      time_ms: 2.5

  - name: facility_shipment_volume
    description: "Reverse traversal: Shipment volume by origin facility"
    applicability:
      keywords: [facility, shipments, origin, throughput, logistics]
      intent: "Find shipment volume originating from each facility"
    parameters:
      - name: limit
        type: integer
        required: false
        default: 10
    sql_template: |
      SELECT f.facility_code, f.name, COUNT(sh.id) as shipment_count,
             ROUND(AVG(sh.weight_kg)::numeric, 2) as avg_weight,
             ROUND(SUM(sh.cost_usd)::numeric, 2) as total_cost
      FROM facilities f
      JOIN shipments sh ON sh.origin_facility_id = f.id
      GROUP BY f.id, f.facility_code, f.name
      ORDER BY shipment_count DESC
      LIMIT {{limit}}
    execution:
      time_ms: 6.3
      result: "FAC-040: 198 shipments, avg 48.66kg, $49.8K"
