# Relationship Pattern: holds_certification (Supplier â†’ SupplierCertification)
# Discovered: Phase 1B - GREEN Relationship Patterns
# Complexity: GREEN

name: certification_relationship_patterns
complexity: GREEN
description: Relationship patterns for holds_certification role

ontology_bindings:
  role: holds_certification
  domain: Supplier
  range: SupplierCertification
  sql:
    table: supplier_certifications
    domain_key: supplier_id
    range_key: id

patterns:
  - name: supplier_certifications
    description: "Forward traversal: Find all certifications for a supplier"
    applicability:
      keywords: [supplier, certifications, holds, compliance, ISO, IATF]
      intent: "Find all certifications held by a supplier"
    parameters:
      - name: supplier_code
        type: string
        required: true
      - name: valid_only
        type: boolean
        required: false
        default: true
    sql_template: |
      SELECT s.supplier_code, s.name,
             sc.certification_type, sc.certification_number,
             sc.issued_date, sc.expiry_date, sc.is_valid
      FROM suppliers s
      JOIN supplier_certifications sc ON sc.supplier_id = s.id
      WHERE s.supplier_code = {{supplier_code}}
        AND ({{valid_only}} = false OR sc.is_valid = true)
      ORDER BY sc.certification_type
    execution:
      time_ms: 5.4

  - name: suppliers_with_multiple_certs
    description: "Find suppliers with multiple valid certifications"
    applicability:
      keywords: [suppliers, certifications, multiple, compliance, qualified]
      intent: "Find suppliers holding 3+ valid certifications"
    parameters:
      - name: min_certs
        type: integer
        required: false
        default: 3
    sql_template: |
      SELECT s.supplier_code, s.name,
             ARRAY_AGG(sc.certification_type ORDER BY sc.certification_type) as certifications
      FROM suppliers s
      JOIN supplier_certifications sc ON sc.supplier_id = s.id
      WHERE sc.is_valid = true
      GROUP BY s.id, s.supplier_code, s.name
      HAVING COUNT(*) >= {{min_certs}}
      ORDER BY COUNT(*) DESC
    execution:
      time_ms: 5.4

  - name: suppliers_by_certification_type
    description: "Reverse traversal: Find suppliers with a specific certification"
    applicability:
      keywords: [suppliers, certification, ISO9001, ISO14001, AS9100, IATF16949, ISO27001]
      intent: "Find all suppliers with a specific certification type"
    parameters:
      - name: certification_type
        type: string
        required: true
        values: [ISO9001, ISO14001, AS9100, IATF16949, ISO27001]
    sql_template: |
      SELECT s.supplier_code, s.name, s.tier, s.country,
             sc.certification_number, sc.expiry_date
      FROM supplier_certifications sc
      JOIN suppliers s ON sc.supplier_id = s.id
      WHERE sc.certification_type = {{certification_type}}
        AND sc.is_valid = true
      ORDER BY s.tier, s.name
    execution:
      time_ms: 1.2
      result: "IATF16949: 132, ISO14001: 132, AS9100: 128, ISO27001: 126, ISO9001: 122 suppliers"
