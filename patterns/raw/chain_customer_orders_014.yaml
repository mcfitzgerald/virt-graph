# Multi-Hop Chain Pattern: Customer → Order → Product
# Discovered: Phase 1C - GREEN Multi-Hop Chains
# Complexity: GREEN

name: customer_order_product_chain
complexity: GREEN
description: Multi-hop chain patterns connecting Customer to Products through Orders

ontology_bindings:
  chain:
    - role: placed_by
      direction: reverse
    - role: contains_item
      direction: forward
  entities: [Customer, Order, Product]

patterns:
  - name: customer_purchase_history
    description: "What products has this customer bought?"
    applicability:
      keywords: [customer, purchased, bought, history, products, orders]
      intent: "Find all products a customer has purchased across all orders"
    parameters:
      - name: customer_code
        type: string
        required: true
    sql_template: |
      SELECT c.customer_code, c.name as customer,
             p.sku, p.name as product,
             SUM(oi.quantity) as total_qty,
             ROUND(SUM(oi.quantity * oi.unit_price)::numeric, 2) as total_spent
      FROM customers c
      JOIN orders o ON o.customer_id = c.id
      JOIN order_items oi ON oi.order_id = o.id
      JOIN products p ON oi.product_id = p.id
      WHERE c.customer_code = {{customer_code}}
      GROUP BY c.customer_code, c.name, p.sku, p.name
      ORDER BY total_spent DESC
    execution:
      time_ms: 8.6

  - name: product_buyers
    description: "Who has bought this product?"
    applicability:
      keywords: [product, buyers, customers, who bought, purchasers]
      intent: "Find all customers who have purchased a specific product"
    parameters:
      - name: sku
        type: string
        required: true
        example: "TURBO-001"
    sql_template: |
      SELECT p.name as product, c.customer_code, c.name as customer,
             SUM(oi.quantity) as qty, COUNT(DISTINCT o.id) as orders
      FROM products p
      JOIN order_items oi ON oi.product_id = p.id
      JOIN orders o ON oi.order_id = o.id
      JOIN customers c ON o.customer_id = c.id
      WHERE p.sku = {{sku}}
      GROUP BY p.name, c.customer_code, c.name
      ORDER BY qty DESC
      LIMIT 20
    execution:
      time_ms: 4.3
      result: "Turbo Encabulator: top buyer 25 units across 2 orders"

  - name: customer_category_spend
    description: "Customer spending by product category"
    applicability:
      keywords: [customer, category, spending, breakdown, analysis]
      intent: "Analyze customer spending across product categories"
    parameters:
      - name: customer_code
        type: string
        required: true
    sql_template: |
      SELECT c.name as customer, p.category,
             COUNT(DISTINCT o.id) as orders,
             SUM(oi.quantity) as units,
             ROUND(SUM(oi.quantity * oi.unit_price)::numeric, 2) as spent
      FROM customers c
      JOIN orders o ON o.customer_id = c.id
      JOIN order_items oi ON oi.order_id = o.id
      JOIN products p ON oi.product_id = p.id
      WHERE c.customer_code = {{customer_code}}
      GROUP BY c.name, p.category
      ORDER BY spent DESC
    execution:
      time_ms: 8.6
