# Pattern Template: Tier Traversal
# Generalized from raw patterns for supply chain tier navigation
name: tier_traversal
description: "Navigate supplier tiers upstream or downstream in supply chain hierarchy"
version: "1.0"

derived_from:
  - patterns/raw/supplier_tier_traversal_001.yaml
  - patterns/raw/upstream_suppliers_001.yaml
  - patterns/raw/downstream_customers_001.yaml
  - patterns/raw/supply_chain_depth_001.yaml

handler: traverse
priority: 1
success_rate: 0.95

# When this pattern applies
applicability:
  query_signals:
    - "tier 1|2|3 supplier"
    - "upstream supplier"
    - "downstream customer"
    - "supply chain depth"
    - "who supplies to"
    - "who does .* supply"
    - "supply chain from"
    - "trace .* supply"
  relationship_properties:
    is_hierarchical: true
    traversal_complexity: YELLOW

# Ontology bindings - how to map to schema
ontology_bindings:
  node_class: Supplier
  edge_relationship: supplies_to
  # supplies_to: seller_id -> buyer_id
  # Direction interpretation:
  #   inbound = upstream (find who supplies TO this entity)
  #   outbound = downstream (find who this entity supplies TO)

# Handler parameters by use case
variants:
  upstream_all:
    description: "Find all upstream suppliers (toward raw materials)"
    direction: inbound
    example_queries:
      - "Who supplies to Acme Corp?"
      - "Find all upstream suppliers"
      - "Trace supply chain upstream"
    handler_params:
      direction: inbound
      max_depth: 10
      include_start: false

  upstream_by_tier:
    description: "Find suppliers at a specific tier"
    direction: inbound
    example_queries:
      - "Find all tier 3 suppliers for Acme Corp"
      - "Who are the tier 2 suppliers?"
    handler_params:
      direction: inbound
      max_depth: 10
      include_start: false
    # Use target_condition with traverse_collecting
    target_condition: "tier = {tier_number}"
    handler_override: traverse_collecting

  downstream_all:
    description: "Find all downstream customers (toward final assembly)"
    direction: outbound
    example_queries:
      - "Who does Eastern Electronics supply to?"
      - "Find all downstream customers"
      - "Trace supply chain downstream"
    handler_params:
      direction: outbound
      max_depth: 10
      include_start: false

  depth_analysis:
    description: "Measure supply chain depth from a starting point"
    direction: inbound
    example_queries:
      - "What is the depth of supply chain from X?"
      - "How many tiers upstream?"
    handler_params:
      direction: inbound
      max_depth: 20  # High to find true depth
      include_start: true
    output_focus: depth_reached

# Parameter resolution from ontology
parameter_mapping:
  nodes_table: "{ontology.tbox.classes.Supplier.sql.table}"
  edges_table: "{ontology.rbox.roles.supplies_to.sql.table}"
  edge_from_col: "{ontology.rbox.roles.supplies_to.sql.domain_key}"
  edge_to_col: "{ontology.rbox.roles.supplies_to.sql.range_key}"

# Example instantiation
example:
  query: "Find all tier 3 suppliers for Acme Corp"
  resolved_params:
    nodes_table: suppliers
    edges_table: supplier_relationships
    edge_from_col: seller_id
    edge_to_col: buyer_id
    start_id: 42  # Acme Corp ID
    target_condition: "tier = 3"
    direction: inbound
    max_depth: 10
  expected_handler: traverse_collecting
