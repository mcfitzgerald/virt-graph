# Virtual Graph Metamodel Extension for LinkML
# Defines extension classes for mapping semantic concepts to SQL schema
#
# This metamodel provides:
# - SQLMappedClass: For entity classes (TBox concepts)
# - SQLMappedRelationship: For relationship classes (RBox roles)
# - Supporting types for operation types, weight columns, etc.

id: https://virt-graph.dev/metamodel
name: virt_graph_metamodel
version: "2.0"
description: >-
  Virtual Graph metamodel extension for LinkML.
  Enables graph-like queries over relational data by mapping
  semantic concepts to physical SQL schema.

prefixes:
  linkml: https://w3id.org/linkml/
  vg: https://virt-graph.dev/

imports:
  - linkml:types

default_range: string

# =============================================================================
# ENUMS
# =============================================================================

enums:
  Cardinality:
    description: "Cardinality constraints for relationship endpoints"
    permissible_values:
      ZERO_OR_ONE:
        description: "0..1 - Optional single value"
      EXACTLY_ONE:
        description: "1..1 - Required single value"
      ZERO_OR_MORE:
        description: "0..* - Optional multiple values"
      ONE_OR_MORE:
        description: "1..* - Required multiple values"

  OperationCategory:
    description: >-
      High-level classification of graph operation families.
      Determines which handler type to use for queries.
    permissible_values:
      direct:
        description: "Simple SQL joins/filters - standard SQL"
      traversal:
        description: "Recursive path-following (BFS/DFS) - traverse() handler"
      temporal:
        description: "Time-aware queries - traverse(valid_at=...) handler"
      aggregation:
        description: "Value aggregation along paths - path_aggregate() handler"
      algorithm:
        description: "Global graph analysis - NetworkX-based handlers"
      pattern:
        description: "Subgraph pattern matching (future)"

  OperationType:
    description: >-
      Specific handler operations. Each type belongs to exactly one category.
      Maps directly to handler functions for query execution.
    permissible_values:
      direct_join:
        description: "Simple FK lookups, junction tables (category: direct)"
      recursive_traversal:
        description: "Multi-hop paths through relationships (category: traversal)"
      temporal_traversal:
        description: "Time-bounded path following (category: temporal)"
      path_aggregation:
        description: "SUM/MAX/MIN along paths (category: aggregation)"
      hierarchical_aggregation:
        description: "Quantity propagation like BOM explosion (category: aggregation)"
      shortest_path:
        description: "Optimal route between nodes (category: algorithm)"
      centrality:
        description: "Node importance ranking (category: algorithm)"
      connected_components:
        description: "Find isolated clusters (category: algorithm)"
      resilience_analysis:
        description: "Impact of node removal (category: algorithm)"

# =============================================================================
# EXTENSION CLASSES
# =============================================================================

classes:
  # ---------------------------------------------------------------------------
  # SQLMappedClass: Extension for entity tables (TBox)
  # ---------------------------------------------------------------------------
  SQLMappedClass:
    class_uri: vg:SQLMappedClass
    description: >-
      Extension class for entities that map to SQL tables.
      Use this for TBox concepts (Supplier, Part, Product, etc.)
    attributes:
      table:
        range: string
        required: true
        description: "SQL table name"
      primary_key:
        range: string
        multivalued: true
        required: true
        minimum_cardinality: 1
        description: "Primary key column(s). Single value for simple keys, list for composite keys (e.g., '[\"order_id\", \"line_number\"]')"
      identifier:
        range: string
        multivalued: true
        description: "Natural key column(s) for human-readable identification"
      soft_delete_column:
        range: string
        description: "Column name for soft delete timestamp (e.g., deleted_at)"
      row_count:
        range: integer
        description: "Estimated row count for query planning"
      context:
        range: ContextBlock
        inlined: true
        description: "Structured context for AI-assisted query generation"

  # ---------------------------------------------------------------------------
  # SQLMappedRelationship: Extension for relationships (RBox)
  # ---------------------------------------------------------------------------
  SQLMappedRelationship:
    class_uri: vg:SQLMappedRelationship
    description: >-
      Extension class for relationships between entities.
      Use this for RBox roles (supplies_to, component_of, connects_to, etc.)
    attributes:
      # === SQL Mapping ===
      edge_table:
        range: string
        required: true
        description: "Edge/junction table name (or target table for embedded FKs)"
      domain_key:
        range: string
        multivalued: true
        required: true
        minimum_cardinality: 1
        description: "FK column(s) pointing to domain class. List for composite keys (e.g., '[\"order_id\", \"line_number\"]')"
      range_key:
        range: string
        multivalued: true
        required: true
        minimum_cardinality: 1
        description: "FK column(s) pointing to range class. List for composite keys"
      domain_class:
        range: string
        multivalued: true
        required: true
        minimum_cardinality: 1
        description: "Name(s) of domain class(es). List for polymorphic relationships"
      range_class:
        range: string
        multivalued: true
        required: true
        minimum_cardinality: 1
        description: "Name(s) of range class(es). List for polymorphic relationships (e.g., '[\"User\", \"Organization\"]')"

      # === Operation Types ===
      operation_types:
        range: OperationType
        multivalued: true
        description: >-
          Operations supported on this relationship.
          Maps to specific handler functions for query execution.

      temporal_bounds:
        range: TemporalBounds
        description: "Time validity configuration for temporal_traversal operations"

      # === OWL 2 Role Axioms ===
      transitive:
        range: boolean
        description: "R(x,y) and R(y,z) implies R(x,z)"
      symmetric:
        range: boolean
        description: "R(x,y) implies R(y,x)"
      asymmetric:
        range: boolean
        description: "R(x,y) implies NOT R(y,x)"
      reflexive:
        range: boolean
        description: "R(x,x) always holds"
      irreflexive:
        range: boolean
        description: "R(x,x) never holds (no self-loops)"
      functional:
        range: boolean
        description: "Each domain element relates to at most one range element"
      inverse_functional:
        range: boolean
        description: "Each range element relates to at most one domain element"

      # === Virtual Graph Extensions ===
      acyclic:
        range: boolean
        description: "DAG constraint - no cycles allowed"
      is_hierarchical:
        range: boolean
        description: "Represents a hierarchical/tree-like structure"
      is_weighted:
        range: boolean
        description: "Relationship has numeric weight columns for network algorithms"
      inverse_of:
        range: string
        description: "Name of inverse relationship (e.g., component_of inverse_of has_component)"

      # === Cardinality ===
      cardinality_domain:
        range: string
        description: "Domain cardinality (e.g., '0..*', '1..1')"
      cardinality_range:
        range: string
        description: "Range cardinality (e.g., '0..*', '1..1')"

      # === DDL Metadata ===
      has_self_ref_constraint:
        range: boolean
        description: "Table has CHECK constraint preventing self-references"
      has_unique_edge_index:
        range: boolean
        description: "Table has unique index on (domain_key, range_key)"
      indexed_columns:
        range: string
        multivalued: true
        description: "List of indexed column names"

      # === Weight Columns (for network algorithms) ===
      weight_columns:
        range: WeightColumn
        multivalued: true
        inlined_as_list: true
        description: "Numeric columns usable as edge weights in network algorithms"

      # === Statistics ===
      row_count:
        range: integer
        description: "Estimated edge count for query planning"

      # === AI Context ===
      context:
        range: ContextBlock
        inlined: true
        description: "Structured context for AI-assisted query generation"

      # === Edge Filtering ===
      sql_filter:
        range: string
        description: "SQL WHERE clause to filter edges (e.g., 'is_active = true AND status != suspended')"

      # === Property Graph Extensions ===
      edge_attributes:
        range: EdgeAttribute
        multivalued: true
        inlined_as_list: true
        description: "Non-weight columns to retrieve as edge properties in Property Graph style"

      # === Polymorphism ===
      type_discriminator:
        range: TypeDiscriminator
        inlined: true
        description: "Configuration for resolving polymorphic target types based on a discriminator column"

  # ---------------------------------------------------------------------------
  # WeightColumn: Describes a numeric column usable as edge weight
  # ---------------------------------------------------------------------------
  WeightColumn:
    class_uri: vg:WeightColumn
    description: "A numeric column that can be used as an edge weight in network algorithms"
    attributes:
      name:
        range: string
        required: true
        description: "Column name"
      type:
        range: string
        required: true
        description: "SQL data type (e.g., 'decimal', 'integer', 'float')"
      description:
        range: string
        description: "Human-readable description of what this weight represents"
      unit:
        range: string
        description: "Unit of measurement (e.g., 'km', 'usd', 'hours')"

  # ---------------------------------------------------------------------------
  # TemporalBounds: Configuration for time-bounded edge filtering
  # ---------------------------------------------------------------------------
  TemporalBounds:
    class_uri: vg:TemporalBounds
    description: >-
      Configuration for time-bounded edge filtering in temporal_traversal operations.
      Specifies which columns contain the validity period for edges.
    attributes:
      start_col:
        range: string
        required: true
        description: "Column containing edge start/effective date"
      end_col:
        range: string
        required: true
        description: "Column containing edge end/expiry date"

  # ---------------------------------------------------------------------------
  # DatabaseConnection: Schema-level metadata for database connection
  # ---------------------------------------------------------------------------
  DatabaseConnection:
    class_uri: vg:DatabaseConnection
    description: "Database connection metadata for schema-level annotation"
    attributes:
      database_type:
        range: string
        required: true
        description: "Database type (e.g., 'postgresql', 'mysql', 'sqlite')"
      database_version:
        range: string
        description: "Database version"
      connection_string:
        range: string
        description: "Connection string template (credentials should be externalized)"

  # ---------------------------------------------------------------------------
  # ContextBlock: Structured context for AI-assisted query generation
  # ---------------------------------------------------------------------------
  ContextBlock:
    class_uri: vg:ContextBlock
    description: "Structured context for AI-assisted query generation"
    attributes:
      business_logic:
        range: string
        description: "Human-readable explanation of entity/relationship behavior"
      llm_prompt_hint:
        range: string
        description: "Hints for AI query construction (e.g., 'For strategic suppliers, filter tier=1')"
      traversal_semantics:
        range: TraversalSemantics
        inlined: true
        description: "Direction-specific traversal meaning"
      examples:
        range: string
        multivalued: true
        description: "Example natural language queries this applies to"

  # ---------------------------------------------------------------------------
  # TraversalSemantics: Direction-specific traversal behavior
  # ---------------------------------------------------------------------------
  TraversalSemantics:
    class_uri: vg:TraversalSemantics
    description: "Direction-specific traversal behavior for relationships"
    attributes:
      inbound:
        range: string
        description: "Meaning of inbound traversal (e.g., 'upstream suppliers')"
      outbound:
        range: string
        description: "Meaning of outbound traversal (e.g., 'downstream buyers')"

  # ---------------------------------------------------------------------------
  # EdgeAttribute: Non-weight column to retrieve as edge property
  # ---------------------------------------------------------------------------
  EdgeAttribute:
    class_uri: vg:EdgeAttribute
    description: "Non-weight column to retrieve as edge property in Property Graph style"
    attributes:
      name:
        range: string
        required: true
        description: "Column name in edge table"
      type:
        range: string
        required: true
        description: "Data type (e.g., 'string', 'date', 'boolean')"
      description:
        range: string
        description: "Human-readable description of this edge property"

  # ---------------------------------------------------------------------------
  # TypeDiscriminator: Polymorphic target type resolution
  # ---------------------------------------------------------------------------
  TypeDiscriminator:
    class_uri: vg:TypeDiscriminator
    description: "Configuration for resolving polymorphic relationship targets"
    attributes:
      column:
        range: string
        required: true
        description: "Column containing type indicator value"
      mapping:
        range: string
        description: "JSON mapping of column values to class names (e.g., '{\"user\": \"User\", \"org\": \"Organization\"}')"
